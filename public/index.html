<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>Tech Tool OPD Card + Follow-up (Clinic Templates)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body {font-family: system-ui, -apple-system, Segoe UI, Roboto, 'TH SarabunPSK', sans-serif; background:#0b1020; color:#e9eefb; margin:0}
    header {background:linear-gradient(90deg,#0f3bd9,#6d95ff); padding:14px 18px; color:#fff}
    main {max-width:980px; margin:20px auto; padding:0 16px 60px}
    section {background:#141a33; border:1px solid #1f2747; border-radius:12px; padding:16px; margin-bottom:16px}
    label {display:block; font-weight:700; color:#cfd8ff; margin-top:6px}
    textarea, input, select {width:100%; padding:10px; border-radius:10px; border:1px solid #283157; background:#0f1530; color:#e9eefb}
    input[type=file]{padding:6px}
    .controls{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    button{padding:10px 14px; border-radius:10px; border:1px solid #4961ff; background:#2342ff; color:#fff; font-weight:700; cursor:pointer}
    button.secondary{background:transparent; border-color:#37406a; color:#cfd8ff}
    .out{white-space:pre-wrap; background:#0f1530; border:1px solid #283157; border-radius:10px; padding:12px; margin-top:8px; min-height:110px}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .row{display:grid; gap:12px}
    @media (min-width:760px){ .row-2{grid-template-columns:1fr 1fr} }
  </style>
</head>
<body>
<header>
  <h2 style="margin:0">Tech Tool OPD Card + Follow-up</h2>
  <div style="opacity:.85">เลือกคลินิก (ไม่จำเพาะโรค) : Neuromed / Neurosx / กายภาพ / จิตเวช / จักษุ</div>
</header>
<main>

  <section>
    <h3 style="margin:0 0 8px 0">1) สรุป OPD จากข้อความ</h3>
    <div class="row row-2">
      <div>
        <label for="clinic1">คลินิก</label>
        <select id="clinic1">
          <option value="neuromed" selected>Neuromed</option>
          <option value="neurosx">Neurosx</option>
          <option value="rehab">กายภาพ/เวชฟื้นฟู</option>
          <option value="psych">จิตเวช</option>
          <option value="oph">จักษุ</option>
        </select>
      </div>
    </div>
    <label for="raw">ข้อความดิบ</label>
    <textarea id="raw" rows="6" placeholder="วาง/พิมพ์ข้อความบันทึกแพทย์ที่นี่..."></textarea>
    <div class="controls">
      <button id="btnText">สรุป OPD</button>
      <button class="secondary" id="btnClearText">ล้าง</button>
    </div>
    <div class="out" id="outText"></div>
  </section>

  <section>
    <h3 style="margin:0 0 8px 0">2) สรุป OPD จากไฟล์เสียง</h3>
    <div class="row row-2">
      <div>
        <label for="clinic2">คลินิก</label>
        <select id="clinic2">
          <option value="neuromed" selected>Neuromed</option>
          <option value="neurosx">Neurosx</option>
          <option value="rehab">กายภาพ/เวชฟื้นฟู</option>
          <option value="psych">จิตเวช</option>
          <option value="oph">จักษุ</option>
        </select>
      </div>
      <div>
        <label for="audio">อัปโหลดไฟล์เสียง</label>
        <input id="audio" type="file" accept="audio/*" />
      </div>
    </div>
    <div class="controls">
      <button id="btnAudio">อัปโหลด & ถอดเสียง → สรุป</button>
      <button class="secondary" id="btnClearAudio">ล้าง</button>
    </div>
    <div class="out" id="outTrans"></div>
    <div class="out" id="outSum"></div>
  </section>

  <section>
    <h3 style="margin:0 0 8px 0">3) แผนติดตาม (Follow-up) แยกตามคลินิก</h3>
    <div class="row row-2">
      <div>
        <label for="clinic3">คลินิก</label>
        <select id="clinic3">
          <option value="neuromed" selected>Neuromed</option>
          <option value="neurosx">Neurosx</option>
          <option value="rehab">กายภาพ/เวชฟื้นฟู</option>
          <option value="psych">จิตเวช</option>
          <option value="oph">จักษุ</option>
        </select>
      </div>
      <div>
        <label for="risk">ระดับความเสี่ยง</label>
        <select id="risk">
          <option value="routine" selected>Routine</option>
          <option value="urgent">Urgent</option>
          <option value="high">High</option>
        </select>
      </div>
    </div>
    <label for="ctx">บริบท/ประเด็นสำคัญของผู้ป่วย</label>
    <textarea id="ctx" rows="5" placeholder="เช่น ปวดศีรษะ/อ่อนแรง/หลังผ่าตัด/ต้องการกายภาพ..."></textarea>
    <div class="controls">
      <button id="btnFU">สร้างแผนติดตาม</button>
      <button class="secondary" id="btnClearFU">ล้าง</button>
    </div>
    <div class="out mono" id="outFUJson"></div>
    <div class="out" id="outFUMd"></div>
  </section>

</main>

<script>
const $ = (id) => document.getElementById(id);

// 1) From text
$('btnText').onclick = async () => {
  const clinicKey = $('clinic1').value;
  const rawText = $('raw').value.trim();
  if (!rawText) return alert('กรุณาใส่ข้อความ');
  $('outText').textContent = 'กำลังสรุป...';
  try{
    const r = await fetch('/api/opd/from-text', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ clinicKey, rawText })
    });
    const d = await r.json();
    $('outText').textContent = d.summary || JSON.stringify(d);
  } catch(e){ $('outText').textContent = 'เกิดข้อผิดพลาด'; }
};
$('btnClearText').onclick = () => { $('raw').value=''; $('outText').textContent=''; };

// 2) From audio
$('btnAudio').onclick = async () => {
  const clinicKey = $('clinic2').value;
  const file = $('audio').files[0];
  if (!file) return alert('กรุณาเลือกไฟล์เสียง');
  $('outTrans').textContent = 'กำลังอัปโหลด & ถอดเสียง...';
  $('outSum').textContent = '';
  try{
    const fd = new FormData();
    fd.append('audio', file);
    fd.append('clinicKey', clinicKey);
    const r = await fetch('/api/opd/upload-audio', { method:'POST', body: fd });
    const d = await r.json();
    $('outTrans').textContent = d.transcript || '(no transcript)';
    $('outSum').textContent = d.summary || '(no summary)';
  } catch(e){ $('outTrans').textContent = 'เกิดข้อผิดพลาด'; }
};
$('btnClearAudio').onclick = () => { $('audio').value=''; $('outTrans').textContent=''; $('outSum').textContent=''; };

// 3) Follow-up per clinic
$('btnFU').onclick = async () => {
  const clinicKey = $('clinic3').value;
  const riskLevel = $('risk').value;
  const contextText = $('ctx').value.trim();
  $('outFUJson').textContent = 'กำลังสร้างแผน...';
  $('outFUMd').textContent = '';
  try{
    const r = await fetch('/api/followup/from-text', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ clinicKey, riskLevel, contextText })
    });
    const d = await r.json();
    if(!d.ok) throw new Error(d.error || 'error');
    $('outFUJson').textContent = JSON.stringify(d.structured, null, 2);
    $('outFUMd').textContent = d.markdown || '';
  } catch(e){ $('outFUJson').textContent = 'เกิดข้อผิดพลาด'; }
};
$('btnClearFU').onclick = () => { $('ctx').value=''; $('outFUJson').textContent=''; $('outFUMd').textContent=''; };
</script>
</body>
</html>
