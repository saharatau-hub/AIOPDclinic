<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>Tech Tool OPD Card + Follow-up (Clinic Templates)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body {font-family: system-ui, -apple-system, Segoe UI, Roboto, 'TH SarabunPSK', sans-serif; background:#0b1020; color:#e9eefb; margin:0}
    header {background:linear-gradient(90deg,#0f3bd9,#6d95ff); padding:14px 18px; color:#fff}
    main {max-width:980px; margin:20px auto; padding:0 16px 60px}
    section {background:#141a33; border:1px solid #1f2747; border-radius:12px; padding:16px; margin-bottom:16px}
    label {display:block; font-weight:700; color:#cfd8ff; margin-top:6px}
    textarea, input, select {width:100%; padding:10px; border-radius:10px; border:1px solid #283157; background:#0f1530; color:#e9eefb}
    input[type=file]{padding:6px}
    .controls{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    button{padding:10px 14px; border-radius:10px; border:1px solid #4961ff; background:#2342ff; color:#fff; font-weight:700; cursor:pointer}
    button.secondary{background:transparent; border-color:#37406a; color:#cfd8ff}
    .out{white-space:pre-wrap; background:#0f1530; border:1px solid #283157; border-radius:10px; padding:12px; margin-top:8px; min-height:110px}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .row{display:grid; gap:12px}
    @media (min-width:760px){ .row-2{grid-template-columns:1fr 1fr} }
  </style>
</head>
<body>
<header>
  <h2 style="margin:0">Tech Tool OPD Card + Follow-up</h2>
  <div style="opacity:.85">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å: Neuromed / Neurosx / ‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û / ‡∏à‡∏¥‡∏ï‡πÄ‡∏ß‡∏ä / ‡∏à‡∏±‡∏Å‡∏©‡∏∏</div>
</header>
<main>

  <!-- 1) ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° -->
  <section>
    <h3 style="margin:0 0 8px 0">1) ‡∏™‡∏£‡∏∏‡∏õ OPD ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</h3>
    <div class="row row-2">
      <div>
        <label for="clinic1">‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å</label>
        <select id="clinic1">
          <option value="neuromed" selected>Neuromed</option>
          <option value="neurosx">Neurosx</option>
          <option value="rehab">‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û/‡πÄ‡∏ß‡∏ä‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π</option>
          <option value="psych">‡∏à‡∏¥‡∏ï‡πÄ‡∏ß‡∏ä</option>
          <option value="oph">‡∏à‡∏±‡∏Å‡∏©‡∏∏</option>
        </select>
      </div>
    </div>
    <label for="raw">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏¥‡∏ö</label>
    <textarea id="raw" rows="6" placeholder="‡∏ß‡∏≤‡∏á/‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>
    <div class="controls">
      <button id="btnText">‡∏™‡∏£‡∏∏‡∏õ OPD</button>
      <button class="secondary" id="btnClearText">‡∏•‡πâ‡∏≤‡∏á</button>
    </div>
    <div class="out" id="outText"></div>
  </section>

  <!-- 2) ‡∏à‡∏≤‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß Record & Summarize + ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡∏£‡∏≠‡∏á) -->
  <section>
    <h3 style="margin:0 0 8px 0">2) ‡∏™‡∏£‡∏∏‡∏õ OPD ‡∏à‡∏≤‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏™‡∏ô‡∏ó‡∏ô‡∏≤ (‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)</h3>
    <div class="row row-2">
      <div>
        <label for="clinic2">‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å</label>
        <select id="clinic2">
          <option value="neuromed" selected>Neuromed</option>
          <option value="neurosx">Neurosx</option>
          <option value="rehab">‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û/‡πÄ‡∏ß‡∏ä‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π</option>
          <option value="psych">‡∏à‡∏¥‡∏ï‡πÄ‡∏ß‡∏ä</option>
          <option value="oph">‡∏à‡∏±‡∏Å‡∏©‡∏∏</option>
        </select>
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="btnRecordOne" style="width:100%">üé§ Record &amp; Summarize</button>
      </div>
    </div>

    <div class="row row-2" style="margin-top:8px">
      <div>
        <label for="audio">‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ</label>
        <input id="audio" type="file" accept="audio/*" />
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="btnUploadFile" class="secondary" style="width:100%">üì§ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
      </div>
    </div>

    <audio id="audioPreview" controls style="width:100%;margin-top:10px;display:none"></audio>
    <div class="out" id="outTrans"></div>
    <div class="out" id="outSum"></div>
  </section>

  <!-- 3) Follow-up Template ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å -->
  <section>
    <h3 style="margin:0 0 8px 0">3) ‡πÅ‡∏ú‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° (Follow-up) ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å</h3>
    <div class="row row-2">
      <div>
        <label for="clinic3">‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å</label>
        <select id="clinic3">
          <option value="neuromed" selected>Neuromed</option>
          <option value="neurosx">Neurosx</option>
          <option value="rehab">‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û/‡πÄ‡∏ß‡∏ä‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π</option>
          <option value="psych">‡∏à‡∏¥‡∏ï‡πÄ‡∏ß‡∏ä</option>
          <option value="oph">‡∏à‡∏±‡∏Å‡∏©‡∏∏</option>
        </select>
      </div>
      <div>
        <label for="risk">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</label>
        <select id="risk">
          <option value="routine" selected>Routine</option>
          <option value="urgent">Urgent</option>
          <option value="high">High</option>
        </select>
      </div>
    </div>
    <label for="ctx">‡∏ö‡∏£‡∏¥‡∏ö‡∏ó/‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</label>
    <textarea id="ctx" rows="5" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏•‡∏±‡∏á‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î/‡∏≠‡πà‡∏≠‡∏ô‡πÅ‡∏£‡∏á/‡∏õ‡∏ß‡∏î/‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û..."></textarea>
    <div class="controls">
      <button id="btnFU">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</button>
      <button class="secondary" id="btnClearFU">‡∏•‡πâ‡∏≤‡∏á</button>
    </div>
    <div class="out mono" id="outFUJson"></div>
    <div class="out" id="outFUMd"></div>
  </section>

</main>

<script>
const $ = (id) => document.getElementById(id);

// 1) From text
$('btnText').onclick = async () => {
  const clinicKey = $('clinic1').value;
  const rawText = $('raw').value.trim();
  if (!rawText) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°');
  $('outText').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡∏∏‡∏õ...';
  try{
    const r = await fetch('/api/opd/from-text', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ clinicKey, rawText })
    });
    const d = await r.json();
    $('outText').textContent = d.summary || JSON.stringify(d);
  } catch(e){ $('outText').textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'; }
};
$('btnClearText').onclick = () => { $('raw').value=''; $('outText').textContent=''; };

// 2) Record & Summarize (‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß) + ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡∏£‡∏≠‡∏á
let mediaRecorderOne = null, chunksOne = [], recordingTimer = null;
const btnRecordOne = $('btnRecordOne'), audioPreview = $('audioPreview');

function setRecBtn(state){ btnRecordOne.textContent = state==='rec' ? '‚èπÔ∏è Stop & Summarize' : 'üé§ Record & Summarize'; }

async function startRec(){
  const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
  const mime = MediaRecorder.isTypeSupported('audio/webm;codecs=opus') ? 'audio/webm;codecs=opus' : 'audio/webm';
  mediaRecorderOne = new MediaRecorder(stream, { mimeType: mime });
  chunksOne = [];
  mediaRecorderOne.ondataavailable = e => { if(e.data.size>0) chunksOne.push(e.data); };
  mediaRecorderOne.onstop = async () => {
    const blob = new Blob(chunksOne, { type: mime });
    const url = URL.createObjectURL(blob);
    audioPreview.src = url; audioPreview.style.display='block';
    await uploadBlobAndSummarize(blob, 'recorded.webm');
  };
  mediaRecorderOne.start(250);
  setRecBtn('rec');
  recordingTimer = setTimeout(()=>{ if(mediaRecorderOne?.state==='recording') mediaRecorderOne.stop(); }, 15*60*1000);
}

function stopRec(){
  if(mediaRecorderOne && mediaRecorderOne.state==='recording'){
    mediaRecorderOne.stop();
    mediaRecorderOne.stream.getTracks().forEach(t=>t.stop());
  }
  clearTimeout(recordingTimer);
  setRecBtn('idle');
}

btnRecordOne.onclick = async () => {
  if(!mediaRecorderOne || mediaRecorderOne.state==='inactive'){
    try{ $('outTrans').textContent='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á...'; $('outSum').textContent=''; await startRec(); }
    catch(e){ $('outTrans').textContent='‚ùå ‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏°‡∏Ñ‡πå: '+(e.message||e); setRecBtn('idle'); }
  } else {
    $('outTrans').textContent='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏ñ‡∏≠‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á...';
    stopRec();
  }
};

async function uploadBlobAndSummarize(blob, filename){
  try{
    const clinicKey = $('clinic2').value;
    const fd = new FormData();
    fd.append('audio', blob, filename);
    fd.append('clinicKey', clinicKey);
    const r = await fetch('/api/opd/upload-audio', { method:'POST', body: fd });
    const d = await r.json();
    if(!d.ok) throw new Error(d.error||'error');
    $('outTrans').textContent = d.transcript || '(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°)';
    $('outSum').textContent = d.summary || '(‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏£‡∏∏‡∏õ)';
  }catch(e){
    $('outTrans').textContent = '‚ùå ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + (e.message||e);
  }
}

$('btnUploadFile').onclick = async ()=>{
  const f = $('audio').files[0];
  if(!f) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Å‡πà‡∏≠‡∏ô');
  audioPreview.src = URL.createObjectURL(f); audioPreview.style.display='block';
  $('outTrans').textContent='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏ñ‡∏≠‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á...'; $('outSum').textContent='';
  await uploadBlobAndSummarize(f, f.name || 'audio.webm');
};

// 3) Follow-up
$('btnFU').onclick = async () => {
  const clinicKey = $('clinic3').value;
  const riskLevel = $('risk').value;
  const contextText = $('ctx').value.trim();
  $('outFUJson').textContent='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô...'; $('outFUMd').textContent='';
  try{
    const r = await fetch('/api/followup/from-text', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ clinicKey, riskLevel, contextText })
    });
    const d = await r.json();
    if(!d.ok) throw new Error(d.error||'error');
    $('outFUJson').textContent = JSON.stringify(d.structured, null, 2);
    $('outFUMd').textContent = d.markdown || '';
  }catch(e){ $('outFUJson').textContent='‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'; }
};
$('btnClearFU').onclick = ()=>{ $('ctx').value=''; $('outFUJson').textContent=''; $('outFUMd').textContent=''; };
</script>
</body>
</html>